---
title: "HW"
author: "Beto"
date: "20 de fevereiro de 2018"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo      = TRUE,
                      warning   = FALSE,
                      message   = FALSE,
                      fig.align = "center",
                      fig.path  ='D:/Users/humberto.pina/Documents/R/SER_III/ST/figuras/', 
                      fig.ext   = 'png')
```

## Análise usando o método Holt-Winters

Referencias:

C. Chatfield
Journal of the Royal Statistical Society. Series C (Applied Statistics)
Vol. 27, No. 3 (1978), pp. 264-279

C. C. Holt (1957) Forecasting seasonals and trends by exponentially weighted moving averages, ONR Research Memorandum, Carnegie Institute of Technology 52. (reprint at http://dx.doi.org/10.1016/j.ijforecast.2003.09.015).

P. R. Winters (1960) Forecasting sales by exponentially weighted moving averages, Management Science 6, 324–342.

A função de predição de Holt-Winters, para séries temporais de período  _p_ em _h_ períodos a frente após a _t -ésima_ observação é dada da seguinte forma:

$\hat{Y}_{t+h} = a_{t} + h * b_{t} + s_{t - p + 1 + (h - 1) mod p}$,

onde $a_{t}$, $b_{t}$ e $s_{t}$ são expressas por

$a_{t} = α (Y_{t} - s_{t-p}) + (1-α) (a_{t-1} + b_{t-1})$

$b_{t} = β (a_{t} - a_{t-1}) + (1-β) b_{t-1}$

$s_{t} = γ (Y_{t} - a_{t}) + (1-γ) s_{t-p}$

A função tenta encontrar parãmetros ótimos para os valores iniciais, fazendo uma decomposição simples em tendência e sazonalidade, usando médias móveis.


USANDO O MÉTODO HOLT-WINTERS NO R.

Para realizar a estimação e posterior previsão pelo método Holt-Winters no R utilizamos a função `HoltWinters`. A função realiza uma decomposição simples para os valores iniciais dos parâmetros_a_, _b_ e _s_.

```{r, echo=FALSE}
# carregando arquivo de dados
vendas <- read.csv("D:/Users/humberto.pina/Documents/R/SER_III/ST/data/IBGE_VVCVA.csv", 
                   header=FALSE, 
                   dec=".",
                   stringsAsFactors = F)
#transposição de linha a coluna em dataframe
vendas2 <- as.data.frame(t(vendas))

# transformação em serie temporal
st_Vendas <- ts(vendas2, 
                start     = c(2003,1), 
                frequency = 12)
```



```{r}
#Realiza o método Holt-Winters
HW <- HoltWinters(st_Vendas)
 
#Plota a série temporal
plot(HW)

#Plota a decomposição da serie
plot(fitted(HW), main = "Decomposição", xlab="Tempo")

```

```{r}
library(tidyverse)
(coef <- cbind(HW["alpha"][[1]],HW["beta"][[1]],HW["gamma"][[1]]))
unl.df <- unlist(fitted(HW))
plot(unl.df[,4])
plot(unl.df[,2])
plot(unl.df[,1])

```



```{r}
#Realiza a previsão para 12 meses a frente
p <- predict(HW, 12, prediction.interval = TRUE, level = 0.95)
plot(HW, p)

HW_prev <- write.csv2(p, "data/HW_prev.csv")
```


```{r}
source("HWplot.R")
graf <- HWplot(st_Vendas, n.ahead = 12, CI=.95,error.ribbon='green',line.size=1)

 graf +
   labs(title = "Série Temporal com Holt-Winters")+
    scale_x_continuous(breaks = seq(2003, 2013)) +
    scale_colour_brewer("Legend", palette = "Set1")
```

